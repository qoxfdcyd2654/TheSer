<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;">
  <meta name="description" content="TheSer — умный поисковик с распознаванием URL и поддержкой тёмной темы">
  <meta name="keywords" content="поиск, поисковик, умный поиск, theser">
  <title>TheSer — умный поиск</title>
  <style>
    /* Сброс стилей */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    /* Переменные для темной и светлой темы */
    :root {
      --color-bg-light: #f5f7fa;
      --color-text-light: #2d3748;
      --color-accent-light: #4361ee;
      --color-secondary-light: #7b68ee;
      --color-error-light: #ff6b6b;
      --color-success-light: #10b981;
      --color-warning-light: #f59e0b;
      --color-overlay-light: rgba(0, 0, 0, 0.1);
      
      --color-bg-dark: #1a1b1e;
      --color-text-dark: #e2e8f0;
      --color-accent-dark: #7b68ee;
      --color-secondary-dark: #4361ee;
      --color-error-dark: #ff6b6b;
      --color-success-dark: #10b981;
      --color-warning-dark: #f59e0b;
      --color-overlay-dark: rgba(255, 255, 255, 0.05);
      
      --transition-speed: 0.3s;
      --border-radius: 16px;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 15px 35px rgba(0, 0, 0, 0.15);
      
      /* Активные значения (изменяются при переключении темы) */
      --color-bg: var(--color-bg-light);
      --color-text: var(--color-text-light);
      --color-accent: var(--color-accent-light);
      --color-secondary: var(--color-secondary-light);
      --color-error: var(--color-error-light);
      --color-success: var(--color-success-light);
      --color-warning: var(--color-warning-light);
      --color-overlay: var(--color-overlay-light);
    }
    
    body.dark {
      --color-bg: var(--color-bg-dark);
      --color-text: var(--color-text-dark);
      --color-accent: var(--color-accent-dark);
      --color-secondary: var(--color-secondary-dark);
      --color-error: var(--color-error-dark);
      --color-success: var(--color-success-dark);
      --color-warning: var(--color-warning-dark);
      --color-overlay: var(--color-overlay-dark);
    }
    
    #theser-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background: var(--color-bg);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
      padding: 20px;
      transition: background-color var(--transition-speed);
    }
    
    .theser-close-btn {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 10000;
      background: var(--color-overlay);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      box-shadow: var(--shadow);
      color: var(--color-text);
      transition: all var(--transition-speed);
    }
    
    .theser-close-btn:hover {
      transform: scale(1.1);
    }

    /* Анимации */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .theser-content {
      text-align: center;
      width: min(100%, 600px);
      padding: 2.5rem 2rem;
      border-radius: var(--border-radius);
      background: rgba(255, 255, 255, 0.7);
      box-shadow: var(--shadow);
      position: relative;
      transition: all var(--transition-speed);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: fadeIn 0.8s ease-out forwards;
    }

    body.dark .theser-content {
      background: rgba(26, 27, 30, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      position: relative;
      margin-bottom: 1.5rem;
    }

    .title {
      font-size: clamp(2rem, 8vw, 3.5rem);
      font-weight: 800;
      user-select: none;
      background: linear-gradient(135deg, var(--color-accent), var(--color-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: float 6s ease-in-out infinite;
    }

    .subtitle {
      font-size: clamp(0.9rem, 3vw, 1rem);
      color: #718096;
      margin-bottom: 2.5rem;
      font-weight: 500;
      line-height: 1.4;
      transition: color var(--transition-speed);
    }

    body.dark .subtitle {
      color: #a0aec0;
    }

    .search-wrapper {
      position: relative;
      margin: 2rem 0;
    }

    input[type="text"] {
      width: 100%;
      padding: 1.2rem 1.8rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 50px;
      outline: none;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      background: var(--color-overlay);
      color: var(--color-text);
      font-weight: 500;
      caret-color: var(--color-accent);
      padding-right: 50px;
      -webkit-appearance: none;
    }

    input[type="text"]::placeholder {
      color: #a0aec0;
      font-weight: 400;
    }

    input[type="text"]:focus {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }

    input.shake {
      animation: shake 0.4s ease;
      box-shadow: 0 0 0 2px var(--color-error);
    }

    .url-indicator {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .url-indicator.visible {
      opacity: 1;
    }

    .url-indicator.valid {
      background-color: var(--color-success);
      color: white;
    }

    .url-indicator.invalid {
      background-color: var(--color-error);
      color: white;
    }

    .url-indicator.warning {
      background-color: var(--color-warning);
      color: white;
    }

    .url-indicator.loading {
      border: 2px solid #d1d5db;
      border-top: 2px solid var(--color-accent);
      animation: spin 1s linear infinite;
      background: transparent;
    }

    body.dark .url-indicator.loading {
      border: 2px solid #4b5563;
      border-top: 2px solid var(--color-accent);
    }

    .search-options {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin: 1.5rem 0;
    }

    .search-engine-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 50px;
      background: rgba(67, 97, 238, 0.1);
      color: var(--color-accent);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 500;
      min-width: 80px;
      flex: 1;
      max-width: 120px;
      touch-action: manipulation;
    }

    .search-engine-btn.active, .search-engine-btn:hover {
      background: var(--color-accent);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .hint {
      margin-top: 1.5rem;
      font-size: 0.9rem;
      color: #718096;
      user-select: none;
      opacity: 0;
      animation: fadeIn 1s 1s ease forwards;
      line-height: 1.4;
      transition: color var(--transition-speed);
    }

    body.dark .hint {
      color: #a0aec0;
    }

    .theme-toggle {
      position: relative;
      top: auto;
      right: auto;
      border: none;
      background: rgba(67, 97, 238, 0.1);
      cursor: pointer;
      font-size: 1.2rem;
      user-select: none;
      color: var(--color-accent);
      transition: all 0.3s ease;
      padding: 10px;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      margin: 0;
      touch-action: manipulation;
    }

    .theme-toggle:hover {
      transform: scale(1.1) rotate(180deg);
      box-shadow: var(--shadow-hover);
    }

    .sun, .moon {
      transition: opacity 0.4s ease, transform 0.4s ease;
      width: 24px;
      height: 24px;
    }

    .moon {
      opacity: 0;
      transform: rotate(180deg);
    }

    body.dark .sun {
      opacity: 0;
      transform: rotate(180deg);
    }

    body.dark .moon {
      opacity: 1;
      transform: rotate(0);
    }

    .background-shapes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }

    .shape {
      position: absolute;
      border-radius: 50%;
      opacity: 0.5;
      filter: blur(40px);
    }

    .shape-1 {
      width: 300px;
      height: 300px;
      background: linear-gradient(45deg, var(--color-accent), var(--color-secondary));
      top: -100px;
      left: -100px;
      animation: gradientShift 15s ease infinite;
    }

    .shape-2 {
      width: 400px;
      height: 400px;
      background: linear-gradient(45deg, var(--color-secondary), #9c6ade);
      bottom: -150px;
      right: -100px;
      animation: gradientShift 18s ease infinite reverse;
    }

    body.dark .shape-1,
    body.dark .shape-2 {
      opacity: 0.3;
    }

    .status-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      background: var(--color-success);
      color: white;
      font-weight: 500;
      box-shadow: var(--shadow);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
      max-width: 90%;
      text-align: center;
    }

    .status-toast.visible {
      opacity: 1;
    }

    .status-toast.error {
      background: var(--color-error);
    }

    .status-toast.warning {
      background: var(--color-warning);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      padding: 16px;
    }

    .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--color-bg);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow-hover);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.visible .modal {
      transform: translateY(0);
    }

    .modal-title {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: var(--color-error);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-content {
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .modal-content p {
      margin-bottom: 1rem;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }

    .modal-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      font-size: 1rem;
      touch-action: manipulation;
    }

    .modal-btn.cancel {
      background: rgba(0, 0, 0, 0.1);
      color: var(--color-text);
    }

    .modal-btn.continue {
      background: var(--color-error);
      color: white;
    }

    .modal-btn:hover {
      transform: translateY(-2px);
    }

    /* Стили для автодополнения */
    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--color-bg);
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      box-shadow: var(--shadow);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      margin-top: 5px;
    }

    .autocomplete-suggestion {
      padding: 12px 20px;
      cursor: pointer;
      text-align: left;
      border-bottom: 1px solid var(--color-overlay);
      transition: background-color 0.2s;
    }

    .autocomplete-suggestion:hover,
    .autocomplete-suggestion.selected {
      background-color: var(--color-overlay);
    }

    .autocomplete-suggestion:last-child {
      border-bottom: none;
    }

    /* Мобильная оптимизация */
    @media (max-width: 768px) {
      #theser-container {
        padding: 10px;
      }
      
      .theser-content {
        padding: 2rem 1.5rem;
      }
      
      .header-wrapper {
        margin-bottom: 1rem;
      }
      
      .title {
        font-size: 2.5rem;
      }
      
      .subtitle {
        margin-bottom: 2rem;
      }
      
      input[type="text"] {
        padding: 1rem 1.5rem;
        font-size: 16px;
      }
      
      .search-options {
        gap: 8px;
        margin: 1.5rem 0;
      }
      
      .search-engine-btn {
        padding: 10px 16px;
        font-size: 0.85rem;
        min-width: 70px;
        max-width: 110px;
      }
      
      .theme-toggle {
        width: 40px;
        height: 40px;
        padding: 8px;
      }
      
      .url-indicator {
        right: 12px;
        width: 20px;
        height: 20px;
        font-size: 12px;
      }
      
      .modal {
        padding: 1.2rem;
      }
      
      .modal-title {
        font-size: 1.1rem;
      }
      
      .modal-btn {
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
      }
      
      .hint {
        font-size: 0.85rem;
      }
      
      .theser-close-btn {
        top: 10px;
        right: 10px;
        width: 35px;
        height: 35px;
        font-size: 18px;
      }
    }

    @media (max-width: 480px) {
      .theser-content {
        padding: 1.5rem 1rem;
      }
      
      .header-wrapper {
        margin-bottom: 1rem;
      }
      
      .title {
        font-size: 2.2rem;
      }
      
      .subtitle {
        margin-bottom: 1.5rem;
        font-size: 0.95rem;
      }
      
      input[type="text"] {
        padding: 1rem 1.2rem;
      }
      
      .search-options {
        gap: 6px;
        margin: 1.2rem 0;
      }
      
      .search-engine-btn {
        padding: 8px 12px;
        font-size: 0.8rem;
        min-width: 65px;
        max-width: 100px;
      }
      
      .theme-toggle {
        width: 38px;
        height: 38px;
        padding: 7px;
      }
      
      .url-indicator {
        right: 12px;
        width: 20px;
        height: 20px;
        font-size: 12px;
      }
      
      .modal {
        padding: 1rem;
      }
      
      .modal-title {
        font-size: 1rem;
      }
      
      .modal-btn {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
      }
      
      .hint {
        font-size: 0.8rem;
      }
    }

    @media (max-width: 350px) {
      .search-engine-btn {
        padding: 8px 10px;
        font-size: 0.75rem;
        min-width: 60px;
        max-width: 90px;
      }
      
      .header-wrapper {
        gap: 10px;
      }
      
      .title {
        font-size: 2rem;
      }
      
      .subtitle {
        font-size: 0.9rem;
      }
    }

    /* Предотвращение zoom при фокусе на iOS */
    @media screen and (max-width: 768px) {
      input[type="text"] {
        font-size: 16px;
      }
    }

    /* Улучшение отзывчивости на мобильных устройствах */
    .search-engine-btn:active,
    .theme-toggle:active,
    .modal-btn:active {
      transform: scale(0.95);
      transition: transform 0.1s ease;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <button class="theser-close-btn" id="theserCloseBtn" style="display: none;" aria-label="Закрыть поиск">×</button>
  <div id="theser-container">
    <div class="background-shapes">
      <div class="shape shape-1"></div>
      <div class="shape shape-2"></div>
    </div>
    
    <div class="theser-content">
      <div class="header-wrapper">
        <h1 class="title">TheSer</h1>
        <button class="theme-toggle" aria-label="Переключить тему" title="Переключить тему">
          <svg class="sun" xmlns="http://www.w3.org/2000/svg" height="24" width="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zm-2.28 11.82l-1.79 1.8 1.41 1.41 1.8-1.79-1.42-1.42zm13.04-9.66h-2v3h2v-3zm-5 1.5a5 5 0 100 10 5 5 0 000-10zm6-2.34l1.42-1.42-1.79-1.8-1.41 1.41 1.78 1.81zm-2.28 11.17v2h3v-2h-3zM4 13h-2v-2h2v2zm14.24 6.36l1.8 1.79 1.41-1.41-1.79-1.8-1.42 1.42zM12 5a7 7 0 110 14 7 7 0 010-14z"/>
          </svg>
          <svg class="moon" xmlns="http://www.w3.org/2000/svg" height="24" width="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M9.37 5.51A7 7 0 0017 15a7 7 0 01-7.63-9.49z"/>
          </svg>
        </button>
      </div>
      
      <p class="subtitle">Умный поиск с распознаванием URL</p>
      
      <div class="search-wrapper">
        <input id="searchInput" type="text" placeholder="Введите запрос или URL адрес" 
              aria-label="Поле для ввода поискового запроса" autofocus autocomplete="off" />
        <div class="url-indicator" id="urlIndicator"></div>
      </div>

      <div class="search-options" aria-label="Выбор поисковой системы">
        <button class="search-engine-btn active" data-engine="google">Google</button>
        <button class="search-engine-btn" data-engine="yandex">Yandex</button>
        <button class="search-engine-btn" data-engine="bing">Bing</button>
        <button class="search-engine-btn" data-engine="duckduckgo">DuckDuckGo</button>
        <button class="search-engine-btn" data-engine="brave">Brave</button>
      </div>

      <div class="hint" id="hintText">Нажмите Enter для поиска в Google</div>
    </div>

    <div class="status-toast" id="statusToast">Перенаправляем на сайт...</div>

    <div class="modal-overlay" id="httpWarningModal">
      <div class="modal">
        <h2 class="modal-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          Небезопасное соединение
        </h2>
        <div class="modal-content">
          <p>Вы пытаетесь перейти на сайт по протоколу HTTP. Этот протокол не шифрует передаваемые данные, что делает его небезопасным.</p>
          <p>Злоумышленники могут перехватить ваши личные данные, такие как пароли, номера кредитных карт и другую конфиденциальную информацию.</p>
          <p>Рекомендуем использовать HTTPS-версию сайта, если она доступна.</p>
        </div>
        <div class="modal-actions">
          <button class="modal-btn cancel" id="cancelHttp">Отмена</button>
          <button class="modal-btn continue" id="continueHttp">Продолжить</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Основной класс приложения
    class TheSer {
      constructor() {
        this.isInIframe = window.self !== window.top;
        this.userInput = '';
        this.currentEngine = this.loadSetting('searchEngine', 'google');
        this.isUrlValid = false;
        this.currentUrl = '';
        this.suggestions = [];
        this.selectedSuggestionIndex = -1;
        
        this.engines = {
          google: { url: 'https://www.google.com/search?q=', hint: 'Google' },
          yandex: { url: 'https://yandex.ru/search/?text=', hint: 'Yandex' },
          bing: { url: 'https://www.bing.com/search?q=', hint: 'Bing' },
          duckduckgo: { url: 'https://duckduckgo.com/?q=', hint: 'DuckDuckGo' },
          brave: { url: 'https://search.brave.com/search?q=', hint: 'Brave' }
        };

        this.init();
      }
      
      init() {
        this.cacheElements();
        this.bindEvents();
        this.loadTheme();
        this.updateHint();
        this.setActiveEngine(this.currentEngine);
        
        // Показать кнопку закрытия, если мы в iframe
        if (this.isInIframe) {
          this.theserCloseBtn.style.display = 'flex';
        }
        
        // Фокусировка на поле ввода после загрузки
        setTimeout(() => {
          this.searchInput.focus();
        }, 500);
      }
      
      cacheElements() {
        this.theserCloseBtn = document.getElementById('theserCloseBtn');
        this.searchInput = document.getElementById('searchInput');
        this.body = document.body;
        this.themeToggleBtn = document.querySelector('.theme-toggle');
        this.hintText = document.getElementById('hintText');
        this.engineButtons = document.querySelectorAll('.search-engine-btn');
        this.urlIndicator = document.getElementById('urlIndicator');
        this.statusToast = document.getElementById('statusToast');
        this.httpWarningModal = document.getElementById('httpWarningModal');
        this.cancelHttpBtn = document.getElementById('cancelHttp');
        this.continueHttpBtn = document.getElementById('continueHttp');
      }
      
      bindEvents() {
        // Обработчик для кнопки закрытия
        this.theserCloseBtn.addEventListener('click', () => {
          document.getElementById('theser-container').style.display = 'none';
          this.theserCloseBtn.style.display = 'none';
        });
        
        // Переключение темы
        this.themeToggleBtn.addEventListener('click', () => {
          this.toggleTheme();
        });
        
        // Обработка ввода
        this.searchInput.addEventListener('input', () => {
          this.handleInput();
        });
        
        this.searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            if (this.selectedSuggestionIndex >= 0 && this.suggestions.length > 0) {
              e.preventDefault();
              this.searchInput.value = this.suggestions[this.selectedSuggestionIndex];
              this.hideSuggestions();
              this.handleInput();
              this.performSearch();
            } else {
              this.performSearch();
            }
          } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            this.selectSuggestion('down');
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            this.selectSuggestion('up');
          } else if (e.key === 'Escape') {
            this.hideSuggestions();
          }
        });
        
        this.searchInput.addEventListener('focus', () => {
          this.showSuggestions();
        });
        
        this.searchInput.addEventListener('blur', () => {
          // Не скрываем сразу, чтобы можно было кликнуть по предложению
          setTimeout(() => this.hideSuggestions(), 200);
        });
        
        // Выбор поисковой системы
        this.engineButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            this.setActiveEngine(btn.dataset.engine);
          });
          
          // Touch события для мобильных устройств
          btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.setActiveEngine(btn.dataset.engine);
          }, { passive: false });
        });
        
        // Обработчики для модального окна HTTP предупреждения
        this.cancelHttpBtn.addEventListener('click', () => {
          this.hideHttpWarning();
          this.showStatus('Переход отменен', false, true);
        });
        
        this.continueHttpBtn.addEventListener('click', () => {
          this.hideHttpWarning();
          this.showStatus('Перенаправляем на сайт...', false, true);
          setTimeout(() => {
            window.open(this.currentUrl, '_blank');
          }, 1000);
        });
        
        // Закрытие модального окна по клику вне его
        this.httpWarningModal.addEventListener('click', (e) => {
          if (e.target === this.httpWarningModal) {
            this.hideHttpWarning();
          }
        });
        
        // Обработка изменения системной цветовой схемы
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          if (!this.loadSetting('theme')) {
            this.body.classList.toggle('dark', e.matches);
          }
        });
      }
      
      // Сохранение настроек
      saveSetting(key, value) {
        try {
          localStorage.setItem(`theser-${key}`, value);
        } catch (e) {
          console.log('Ошибка сохранения настройки:', e);
        }
      }
      
      // Загрузка настроек
      loadSetting(key, defaultValue = null) {
        try {
          return localStorage.getItem(`theser-${key}`) || defaultValue;
        } catch (e) {
          console.log('Ошибка загрузки настройки:', e);
          return defaultValue;
        }
      }
      
      // Загрузка темы
      loadTheme() {
        const savedTheme = this.loadSetting('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme) {
          this.body.classList.toggle('dark', savedTheme === 'dark');
        } else {
          this.body.classList.toggle('dark', systemDark);
        }
      }
      
      // Переключение темы
      toggleTheme() {
        const isDark = this.body.classList.toggle('dark');
        this.saveSetting('theme', isDark ? 'dark' : 'light');
      }
      
      // Установка активной поисковой системы
      setActiveEngine(engine) {
        this.engineButtons.forEach(b => b.classList.remove('active'));
        const activeBtn = Array.from(this.engineButtons).find(b => b.dataset.engine === engine);
        if (activeBtn) activeBtn.classList.add('active');
        
        this.currentEngine = engine;
        this.saveSetting('searchEngine', engine);
        this.updateHint();
      }
      
      // Обновление подсказки
      updateHint() {
        if (this.isUrlValid) {
          this.hintText.textContent = `Нажмите Enter для перехода по сайту`;
        } else {
          this.hintText.textContent = `Нажмите Enter для поиска в ${this.engines[this.currentEngine].hint}`;
        }
      }
      
      // Проверка безопасности URL
      isValidURL(url) {
        try {
          const parsedUrl = new URL(url);
          // Разрешаем только HTTP/HTTPS
          return ['http:', 'https:'].includes(parsedUrl.protocol);
        } catch (e) {
          return false;
        }
      }
      
      // Проверка, является ли строка URL
      looksLikeUrl(string) {
        // Быстрая проверка по наличию пробелов
        if (/\s/.test(string)) return false;
        
        try {
          // Если строка начинается с протокола
          if (/^https?:\/\//i.test(string)) {
            const url = new URL(string);
            return url.hostname.includes('.') && url.hostname.length > 3;
          }
          
          // Проверка на доменное имя без протокола
          if (/^[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+/.test(string) && 
              !string.includes(' ') && 
              string.includes('.') && 
              string.length > 3) {
            return true;
          }
          
          return false;
        } catch (_) {
          return false;
        }
      }
      
      // Нормализация URL (добавление https:// если нужно)
      normalizeUrl(url) {
        if (/^https?:\/\//i.test(url)) {
          return url;
        }
        return 'https://' + url;
      }
      
      // Обновление индикатора URL
      updateUrlIndicator(valid, loading = false, isHttp = false) {
        if (loading) {
          this.urlIndicator.className = 'url-indicator loading';
          this.urlIndicator.classList.add('visible');
          return;
        }
        
        if (valid) {
          if (isHttp) {
            this.urlIndicator.textContent = '!';
            this.urlIndicator.className = 'url-indicator warning';
          } else {
            this.urlIndicator.textContent = '✓';
            this.urlIndicator.className = 'url-indicator valid';
          }
        } else {
          this.urlIndicator.textContent = '✕';
          this.urlIndicator.className = 'url-indicator invalid';
        }
        
        this.urlIndicator.classList.add('visible');
      }
      
      // Показать статус
      showStatus(message, isError = false, isWarning = false) {
        this.statusToast.textContent = message;
        this.statusToast.className = 'status-toast';
        if (isError) this.statusToast.classList.add('error');
        if (isWarning) this.statusToast.classList.add('warning');
        this.statusToast.classList.add('visible');
        
        setTimeout(() => {
          this.statusToast.classList.remove('visible');
        }, 3000);
      }
      
      // Обработка ввода
      async handleInput() {
        this.userInput = this.searchInput.value.trim();
        
        if (!this.userInput) {
          this.urlIndicator.classList.remove('visible');
          this.isUrlValid = false;
          this.hideSuggestions();
          this.updateHint();
          return;
        }
        
        // Показываем предложения
        this.showSuggestions();
        
        const hasProtocol = /^https?:\/\//i.test(this.userInput);
        
        if (this.looksLikeUrl(this.userInput)) {
          const normalizedUrl = this.normalizeUrl(this.userInput);
          const isHttp = /^http:\/\//i.test(normalizedUrl);
          
          if (this.isValidURL(normalizedUrl)) {
            this.updateUrlIndicator(true, false, isHttp);
            this.isUrlValid = true;
            this.currentUrl = normalizedUrl;
          } else {
            this.updateUrlIndicator(false);
            this.isUrlValid = false;
          }
        } else {
          this.urlIndicator.classList.remove('visible');
          this.isUrlValid = false;
        }
        
        this.updateHint();
      }
      
      // Выполнение поиска/перехода
      async performSearch() {
        if (!this.userInput.trim()) {
          this.searchInput.classList.add('shake');
          setTimeout(() => this.searchInput.classList.remove('shake'), 400);
          return;
        }

        if (this.isUrlValid && this.currentUrl) {
          // Проверяем URL на безопасность
          if (!this.isValidURL(this.currentUrl)) {
            this.showStatus('Ошибка: разрешены только HTTP/HTTPS ссылки!', true);
            return;
          }

          if (/^http:\/\//i.test(this.currentUrl)) {
            this.showHttpWarning();
          } else {
            this.showStatus('Перенаправляем на сайт...');
            setTimeout(() => {
              window.open(this.currentUrl, '_blank');
            }, 1000);
          }
        } else {
          const searchURL = this.engines[this.currentEngine].url + encodeURIComponent(this.userInput);
          window.open(searchURL, '_blank');
          this.saveToHistory(this.userInput);
        }
        
        this.searchInput.value = '';
        this.userInput = '';
        this.urlIndicator.classList.remove('visible');
        this.isUrlValid = false;
        this.hideSuggestions();
        this.updateHint();
      }
      
      // Показать предупреждение о HTTP
      showHttpWarning() {
        this.httpWarningModal.classList.add('visible');
      }
      
      // Скрыть предупреждение о HTTP
      hideHttpWarning() {
        this.httpWarningModal.classList.remove('visible');
      }
      
      // Сохранение в историю
      saveToHistory(query) {
        try {
          const history = JSON.parse(localStorage.getItem('theser-history') || '[]');
          
          // Добавляем запрос, если его еще нет в истории
          if (!history.includes(query)) {
            history.unshift(query);
            // Сохраняем только последние 10 запросов
            const limitedHistory = history.slice(0, 10);
            localStorage.setItem('theser-history', JSON.stringify(limitedHistory));
          }
        } catch (e) {
          console.log('Ошибка сохранения истории:', e);
        }
      }
      
      // Получение истории поиска
      getHistory() {
        try {
          return JSON.parse(localStorage.getItem('theser-history') || '[]');
        } catch (e) {
          console.log('Ошибка загрузки истории:', e);
          return [];
        }
      }
      
      // Показать предложения
      showSuggestions() {
        this.hideSuggestions();
        
        const history = this.getHistory();
        const input = this.searchInput.value.trim().toLowerCase();
        
        if (input.length === 0 && history.length === 0) return;
        
        // Фильтруем историю по введенному тексту
        this.suggestions = history.filter(item => 
          item.toLowerCase().includes(input)
        );
        
        if (this.suggestions.length === 0) return;
        
        const suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'autocomplete-suggestions';
        suggestionsDiv.id = 'autocomplete-suggestions';
        
        this.suggestions.forEach((suggestion, index) => {
          const div = document.createElement('div');
          div.className = 'autocomplete-suggestion';
          div.textContent = suggestion;
          div.addEventListener('click', () => {
            this.searchInput.value = suggestion;
            this.hideSuggestions();
            this.handleInput();
          });
          suggestionsDiv.appendChild(div);
        });
        
        this.searchInput.parentNode.appendChild(suggestionsDiv);
        this.selectedSuggestionIndex = -1;
      }
      
      // Скрыть предложения
      hideSuggestions() {
        const suggestions = document.getElementById('autocomplete-suggestions');
        if (suggestions) suggestions.remove();
        this.selectedSuggestionIndex = -1;
      }
      
      // Выбор предложения с клавиатуры
      selectSuggestion(direction) {
        if (this.suggestions.length === 0) return;
        
        const suggestions = document.querySelectorAll('.autocomplete-suggestion');
        
        if (direction === 'down') {
          this.selectedSuggestionIndex = (this.selectedSuggestionIndex + 1) % this.suggestions.length;
        } else if (direction === 'up') {
          this.selectedSuggestionIndex = this.selectedSuggestionIndex - 1 < 0 
            ? this.suggestions.length - 1 
            : this.selectedSuggestionIndex - 1;
        }
        
        suggestions.forEach((s, i) => {
          s.classList.toggle('selected', i === this.selectedSuggestionIndex);
        });
        
        // Прокрутка к выбранному элементу
        if (suggestions[this.selectedSuggestionIndex]) {
          suggestions[this.selectedSuggestionIndex].scrollIntoView({
            block: 'nearest'
          });
        }
      }
    }

    // Инициализация приложения после загрузки DOM
    document.addEventListener('DOMContentLoaded', () => {
      new TheSer();
    });
  </script>
</body>
</html>
